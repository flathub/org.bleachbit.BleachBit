id: org.bleachbit.BleachBit
runtime: org.gnome.Platform
runtime-version: '44'
sdk: org.gnome.Sdk
command: bleachbit
finish-args:
  - --device=dri
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --filesystem=home
  # update cleaner rules
  - --share=network
  - --own-name=org.gnome.Bleachbit
  # https://github.com/flathub/flathub/issues/2180
  - --filesystem=xdg-run/gvfs
  - --filesystem=xdg-run/gvfsd
  - --talk-name=org.gtk.vfs.*
rename-icon: bleachbit
modules:
  - name: bleach
    builddir: true
    no-autogen: true
    cleanup:
      - /share/pixmaps
    sources:
      - type: archive
        archive-type: tar-gzip
        # v4.5.0 has not been released and raises a no module error: https://github.com/bleachbit/bleachbit/issues/1550
        url: https://api.github.com/repos/bleachbit/bleachbit/tarball/v4.4.2
        sha256: d4b4f52686eaa00b494158ff5d7508cc66efdf7ca30e7d802f0d1592f247d7e0
        x-checker-data:
          type: json
          url: https://api.github.com/repos/bleachbit/bleachbit/releases/latest
          version-query: .tag_name
          url-query: .tarball_url
          timestamp-query: .published_at
      - type: shell
        commands:
          - >-
            sed -i -e 's|/usr/local|/app|g' -e 's|/usr/share|/app/share|g'
            Makefile setup.py bleachbit/__init__.py po/Makefile bleachbit.py

          # Remove Windows-specific functionality.
          - make delete_windows_files

          # By default it installs to /app/share/pixmaps
          - >-
            install -Dm0644 bleachbit.png
            "${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/bleachbit.png"

          # Disable update notifications, since package will be updated by Flatpak or Packagekit.
          - >-
            sed 's/online_update_notification_enabled =
            True/online_update_notification_enabled = False/g'  --in-place
            ./bleachbit/__init__.py

          # Put the version to the metadata
          - >-
            appstream-util modify org.bleachbit.BleachBit.metainfo.xml releases
            "<release version=\"$(git describe --tags)\" date=\"$(git log -1 --format=%ci
            | awk '{print $1}')\"/>"
          - sed -i -e "s,<releases>&lt;,<releases><," -e "s,&gt;</releases>,></releases>,"
            org.bleachbit.BleachBit.metainfo.xml
