id: org.bleachbit.BleachBit
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk
command: bleachbit
finish-args:
  - --device=dri
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --filesystem=home
  - --filesystem=~/.var/app
  # See https://github.com/flathub/org.bleachbit.BleachBit/pull/21
  - --filesystem=/tmp
  - --filesystem=/var/tmp
  # https://github.com/bleachbit/bleachbit/blob/b64d7e38c518f533388df439190cf4e1f9139ff7/bleachbit/Cleaner.py#L486-L488
  - --filesystem=/var/log
  # update cleaner rules
  - --share=network
  - --own-name=org.gnome.Bleachbit
  # https://github.com/flathub/flathub/issues/2180
  - --filesystem=xdg-run/gvfs
  - --filesystem=xdg-run/gvfsd
  - --talk-name=org.gtk.vfs.*
rename-icon: bleachbit
modules:
  - name: bleach
    builddir: true
    no-autogen: true
    cleanup:
      - /share/pixmaps
    sources:
      - type: git
        url: https://github.com/bleachbit/bleachbit.git
        tag: v5.0.0
        commit: ece0c513be9278529c17730b9b305c714f728550
        x-checker-data:
          type: anitya
          project-id: 200
          stable-only: true
          tag-template: v$version
      - type: shell
        commands:
          - >-
            sed -i -e 's|/usr/local|/app|g' -e 's|/usr/share|/app/share|g'
            Makefile setup.py bleachbit/__init__.py po/Makefile bleachbit.py

          # Remove Windows-specific functionality.
          - make delete_windows_files

          # By default it installs to /app/share/pixmaps
          - >-
            install -Dm0644 bleachbit.png
            "${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/bleachbit.png"

          # Disable update notifications, since package will be updated by Flatpak or Packagekit.
          - >-
            sed 's/online_update_notification_enabled =
            True/online_update_notification_enabled = False/g'  --in-place
            ./bleachbit/__init__.py

          # Add <releases> section with <release> tag as the last tag in the metadata
          - >-
            sed -i -e "/<\/component>/i <releases><release version=\"$(git describe
            --tags)\" date=\"$(git log -1 --format=%ci | awk '{print $1}')\"/></releases>"
            org.bleachbit.BleachBit.metainfo.xml
